<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø«Ø± | Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ù„Ù…Ù‚Ø§Ø¨Ù„Ø§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="protection.js"></script>
    <style>
        .page-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
        }

        .input-card {
            background: var(--glass-bg);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            margin-bottom: 30px;
        }

        textarea,
        input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            margin-bottom: 15px;
            font-family: 'Cairo';
        }

        .btn-full {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            border: none;
            background: var(--primary);
            color: white;
            transition: 0.3s;
        }

        .result-card {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 15px;
            display: none;
            line-height: 1.8;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 5px;
            margin: 25px 0 10px;
            font-weight: 900;
        }

        .question-box {
            background: #f8fafc;
            border-right: 4px solid var(--primary);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .answer-box {
            font-size: 0.95rem;
            color: #4b5563;
            background: #fff;
            padding: 10px;
            border: 1px dashed #ddd;
            margin-top: 10px;
        }
    </style>
</head>

<body class="light-theme">
    <nav>
        <div class="logo-container">
            <a href="index.html" style="text-decoration:none; display:flex; align-items:center; gap:10px;">
                <img src="ØªÙ†Ø²ÙŠÙ„.jpg" alt="Logo" style="width:40px; border-radius:5px;">
                <div class="logo">Ø£Ø«Ù€Ù€Ù€Ù€Ù€Ø±</div>
            </a>
        </div>
        <div class="nav-actions">
            <a href="index.html" class="btn btn-ghost">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="career_path.html" class="btn btn-ghost">Ù…Ø³Ø§Ø±Ùƒ Ø§Ù„Ù…Ù‡Ù†ÙŠ</a>
            <a href="skill_dev.html" class="btn btn-ghost">ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</a>
        </div>
    </nav>

    <div class="page-container">
        <header style="text-align:center; margin-bottom:40px;">
            <h1 style="font-weight:900; color:var(--primary); font-size: 2.5rem;">ğŸ¯ Ù…Ø­Ù„Ù„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ÙˆØ§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø§Øª</h1>
            <p style="color:var(--text-secondary);">Ø­Ù„Ù„ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ©ØŒ ÙˆØ§ÙƒØªØ´Ù Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ø¹ Ø¥Ø¬Ø§Ø¨Ø§Øª Ù†Ù…ÙˆØ°Ø¬ÙŠØ©.</p>
        </header>

        <div class="input-card">
            <div class="form-group">
                <label>Ø£Ø¯Ø®Ù„ Ù†Øµ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ© (Ø£Ùˆ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©):</label>
                <textarea id="jobAd" rows="8" placeholder="Ø§Ù„ØµÙ‚ Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù‡Ù†Ø§..."></textarea>
            </div>
            <div class="form-group">
                <label>Ø³ÙŠØ±ØªÙƒ Ø§Ù„Ø°Ø§ØªÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ØªØ®ØµÙŠØµ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©):</label>
                <textarea id="cvText" rows="4" placeholder="Ø§Ù„ØµÙ‚ Ù†Øµ Ø³ÙŠØ±ØªÙƒ Ø§Ù„Ø°Ø§ØªÙŠØ© Ù‡Ù†Ø§..."></textarea>
            </div>
            <button id="analyzeBtn" class="btn-full">ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ© ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ âš¡</button>
        </div>

        <div id="statusLog" style="text-align:center; margin-bottom:20px; font-weight:bold;"></div>

        <div id="resultArea" class="result-card">
            <div id="analysisHeader"
                style="background:#e0f2fe; padding:15px; border-radius:10px; margin-bottom:20px; text-align:center;">
                <h3 id="jobLevel" style="margin:0; color:#0369a1;"></h3>
            </div>
            <div id="analysisContent"></div>
            <div class="section-title">ğŸ¤ Ø£Ø³Ø¦Ù„Ø© Ù…Ù‚Ø§Ø¨Ù„Ø© Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ø¹ Ø¥Ø¬Ø§Ø¨Ø§Øª Ù†Ù…ÙˆØ°Ø¬ÙŠØ©</div>
            <div id="questionsArea"></div>
            <button id="exportBtn" class="btn btn-ghost" style="margin-top:20px; width:100%; border:1px solid #ddd;">ğŸ“¥
                Ø·Ø¨Ø§Ø¹Ø© Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©</button>
        </div>
    </div>

    <script>
        const BRIDGE_URL = "https://script.google.com/macros/s/AKfycbzCic7XWHobosbwc4PR7_zoS1aZqO6u2UO2-C5Sjm1Nrk7S_iKiCekYa-2Mz84tz-RC/exec";

        document.getElementById('analyzeBtn').onclick = async () => {
            const ad = document.getElementById('jobAd').value;
            const cv = document.getElementById('cvText').value;

            if (!ad) return alert("ÙŠØ±Ø¬Ù‰ Ù„ØµÙ‚ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ©.");

            const btn = document.getElementById('analyzeBtn');
            const status = document.getElementById('statusLog');
            btn.disabled = true;
            status.innerText = "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...";

            const prompt = `
            Ø£Ù†Øª Ù…Ø³Ø¤ÙˆÙ„ ØªÙˆØ¸ÙŠÙ Ø£ÙˆÙ„ (Senior HR) ÙÙŠ Ù…Ù†Ø¸Ù…Ø© Ø¯ÙˆÙ„ÙŠØ©.
            Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª:
            - Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ©: ${ad}
            - Ø³ÙŠØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${cv || 'Ù„Ù… ØªÙˆÙØ±'}

            Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (JSON Ø­ØµØ±Ø§Ù‹):
            {
                "level": "Junior|Officer|Senior",
                "competencies": ["ÙƒÙØ§Ø¡Ø© 1", "ÙƒÙØ§Ø¡Ø© 2", "ÙƒÙØ§Ø¡Ø© 3", "ÙƒÙØ§Ø¡Ø© 4"],
                "keywords": ["ÙƒÙ„Ù…Ø© 1", "ÙƒÙ„Ù…Ø© 2", "ÙƒÙ„Ù…Ø© 3"],
                "match_score": "80%",
                "questions": [
                    {
                        "type": "Technical|Behavioral|Scenario",
                        "question": "Ø§Ù„Ø³Ø¤Ø§Ù„",
                        "answer": "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ© Ø§Ù„Ù…ÙØµÙ„Ø©",
                        "intent": "Ù…Ø§Ø°Ø§ ÙŠØ¨Ø­Ø« Ø¹Ù†Ù‡ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ Ù‡Ù†Ø§"
                    }
                ],
                "tips": ["Ù†ØµÙŠØ­Ø© 1", "Ù†ØµÙŠØ­Ø© 2"]
            }
            
            âš ï¸ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹: ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ù…ØµÙÙˆÙØ© questions Ø¹Ù„Ù‰ 30 Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø¨Ø§Ù„Ø¶Ø¨Ø· (Ù„Ø§ Ø£Ù‚Ù„ ÙˆÙ„Ø§ Ø£ÙƒØ«Ø±).
            Ù†ÙˆÙ‘Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨ÙŠÙ† Technical (ØªÙ‚Ù†ÙŠØ©)ØŒ Behavioral (Ø³Ù„ÙˆÙƒÙŠØ©)ØŒ Ùˆ Scenario (Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª).
            Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…ÙØµÙ„Ø© ÙˆØ´Ø§Ù…Ù„Ø© (100-150 ÙƒÙ„Ù…Ø© Ù„ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø©).
            Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.
            `;

            const tryParse = (str) => {
                try { return JSON.parse(str); } catch (e) { return null; }
            };

            const cleanText = (text) => {
                let clean = text.replace(/```json\s*|```\s*/gi, "").trim();
                const start = clean.indexOf('{');
                const end = clean.lastIndexOf('}');
                if (start !== -1 && end !== -1 && end > start) {
                    return clean.substring(start, end + 1);
                }
                return clean;
            };

            try {
                const res = await fetch(BRIDGE_URL + "?action=ai", {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [{ role: "user", content: prompt + "\n\nIMPORTANT: Return ONLY valid JSON." }],
                        temperature: 0.3
                    })
                });

                const dataText = await res.text();
                if (!dataText) throw new Error("Empty response");

                let parsed = tryParse(dataText);
                let content = "";

                if (parsed && parsed.choices && parsed.choices[0] && parsed.choices[0].message) {
                    content = parsed.choices[0].message.content;
                } else {
                    content = dataText;
                }

                // (Fixed) Removed false positive error check
                if (content.startsWith("Error:") || content.includes("Rate limit exceeded")) {
                    status.innerText = "âš ï¸ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø®Ø§Ø¯Ù… Ù…Ø´ØºÙˆÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹.";
                    return;
                }

                const json = tryParse(cleanText(content));
                if (!json) throw new Error("JSON Parsing failed");

                document.getElementById('jobLevel').innerText = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${json.level || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} | Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆØ§ÙÙ‚: ${json.match_score || '0%'}`;

                let contentHtml = `
                    <div class="section-title">ğŸ” Ø§Ù„ÙƒÙØ§Ø¡Ø§Øª ÙˆØ§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©</div>
                    <p><strong>Ø§Ù„ÙƒÙØ§Ø¡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</strong> ${(json.competencies || []).join(' - ')}</p>
                    <p><strong>ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</strong> ${(json.keywords || []).map(k => `<span style="background:#f1f5f9; padding:2px 8px; border-radius:4px; margin-left:5px;">${k}</span>`).join('')}</p>
                `;
                document.getElementById('analysisContent').innerHTML = contentHtml;

                let qHtml = '';
                (json.questions || []).forEach(q => {
                    qHtml += `
                        <div class="question-box">
                            <span style="font-size:0.8rem; background:#3b82f6; color:white; padding:2px 10px; border-radius:10px;">${q.type || 'Ø³Ø¤Ø§Ù„'}</span>
                            <p style="font-weight:bold; margin:10px 0;">${q.question || ''}</p>
                            <div style="font-size:0.85rem; color:#6b7280; font-style:italic;">Ø§Ù„Ù‡Ø¯Ù: ${q.intent || ''}</div>
                            <div class="answer-box"><strong>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:</strong> ${q.answer || ''}</div>
                        </div>
                    `;
                });
                document.getElementById('questionsArea').innerHTML = qHtml;

                document.getElementById('resultArea').style.display = 'block';
                status.innerText = "âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!";
                window.scrollTo({ top: document.getElementById('resultArea').offsetTop - 50, behavior: 'smooth' });

            } catch (e) {
                console.error("AI Error:", e);
                status.innerText = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.";
            } finally {
                btn.disabled = false;
            }
        };
        document.getElementById('exportBtn').onclick = () => {
            ProtectionManager.verify(() => window.print());
        };
    </script>
</body>

</html>