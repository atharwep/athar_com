<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø«Ø± | Ù…Ø³Ø§Ø±Ùƒ Ø§Ù„Ù…Ù‡Ù†ÙŠ ÙÙŠ Ø§Ù„Ù…Ù†Ø¸Ù…Ø§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="protection.js"></script>
    <style>
        .page-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
        }

        .input-card {
            background: var(--glass-bg);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            margin-bottom: 30px;
        }

        textarea,
        input,
        select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            margin-bottom: 15px;
            font-family: 'Cairo';
        }

        .btn-full {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            border: none;
            background: var(--primary);
            color: white;
            transition: 0.3s;
        }

        .btn-full:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .result-card {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 15px;
            display: none;
            line-height: 1.8;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .badge-high {
            background: #10b981;
            color: white;
        }

        .badge-mid {
            background: #f59e0b;
            color: white;
        }

        .badge-low {
            background: #ef4444;
            color: white;
        }

        .section-title {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 5px;
            margin: 20px 0 10px;
            font-weight: 900;
        }
    </style>
</head>

<body class="light-theme">
    <nav>
        <div class="logo-container">
            <a href="index.html" style="text-decoration:none; display:flex; align-items:center; gap:10px;">
                <img src="ØªÙ†Ø²ÙŠÙ„.jpg" alt="Logo" style="width:40px; border-radius:5px;">
                <div class="logo">Ø£Ø«Ù€Ù€Ù€Ù€Ù€Ø±</div>
            </a>
        </div>
        <div class="nav-actions">
            <a href="index.html" class="btn btn-ghost">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="job_prep.html" class="btn btn-ghost">Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ù„Ù…Ù‚Ø§Ø¨Ù„Ø§Øª</a>
            <a href="skill_dev.html" class="btn btn-ghost">ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</a>
        </div>
    </nav>

    <div class="page-container">
        <header style="text-align:center; margin-bottom:40px;">
            <h1 style="font-weight:900; color:var(--primary); font-size: 2.5rem;">ğŸš€ Ø¨ÙˆØ§Ø¨ØªÙƒ Ù„Ù„Ø¹Ù…Ù„ ÙÙŠ Ø§Ù„Ù…Ù†Ø¸Ù…Ø§Øª</h1>
            <p style="color:var(--text-secondary);">Ø­Ù„Ù„ Ø¬Ø§Ù‡Ø²ÙŠØªÙƒØŒ ÙˆØ­Ø¯Ø¯ Ù…Ø³Ø§Ø±Ùƒ Ø§Ù„Ù…Ù‡Ù†ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¥Ù†Ø³Ø§Ù†ÙŠ Ø¨Ø¯Ù‚Ø©.</p>
        </header>

        <div class="input-card">
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø¤Ù‡Ù„ Ø§Ù„Ø¹Ù„Ù…ÙŠ ÙˆØ§Ù„ØªØ®ØµØµ:</label>
                <input type="text" id="education" placeholder="Ù…Ø«Ø§Ù„: Ø¨ÙƒØ§Ù„ÙˆØ±ÙŠÙˆØ³ Ø¥Ø¯Ø§Ø±Ø© Ø£Ø¹Ù…Ø§Ù„ØŒ Ù‡Ù†Ø¯Ø³Ø© Ù…Ø¯Ù†ÙŠØ©...">
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø®Ø¨Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ø¨Ø´ÙƒÙ„ Ù…Ø®ØªØµØ±):</label>
                <textarea id="experience" rows="4"
                    placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù…Ù„Øª Ù„Ù…Ø¯Ø© Ø³Ù†ØªÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©ØŒ Ù…ØªØ·ÙˆØ¹ Ø³Ø§Ø¨Ù‚ ÙÙŠ Ø§Ù„Ù‡Ù„Ø§Ù„ Ø§Ù„Ø£Ø­Ù…Ø±..."></textarea>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø¨Ù„Ø¯ Ø£Ùˆ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù:</label>
                <input type="text" id="targetCountry" placeholder="Ù…Ø«Ø§Ù„: Ø´Ù…Ø§Ù„ ØºØ±Ø¨ Ø³ÙˆØ±ÙŠØ§ØŒ Ø§Ù„ÙŠÙ…Ù†ØŒ Ù…Ø®ÙŠÙ…Ø§Øª Ø§Ù„Ø£Ø±Ø¯Ù†...">
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ù…Ø±ØºÙˆØ¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                <select id="targetField">
                    <option value="General">Ø¹Ø§Ù… / Ø£ÙŠ Ù…Ø¬Ø§Ù„</option>
                    <option value="Logistics">Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª ÙˆØ§Ù„Ø¥Ù…Ø¯Ø§Ø¯</option>
                    <option value="HR">Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</option>
                    <option value="Protection">Ø§Ù„Ø­Ù…Ø§ÙŠØ©</option>
                    <option value="Education">Ø§Ù„ØªØ¹Ù„ÙŠÙ…</option>
                    <option value="WASH">Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ø¥ØµØ­Ø§Ø­</option>
                    <option value="Finance">Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>
                    <option value="MEAL">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ… (MEAL)</option>
                </select>
            </div>
            <button id="analyzeBtn" class="btn-full">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù‡Ù†ÙŠ âš¡</button>
        </div>

        <div id="statusLog" style="text-align:center; margin-bottom:20px; font-weight:bold;"></div>

        <div id="resultArea" class="result-card">
            <div id="readinessBadge"></div>
            <div id="analysisContent"></div>
            <button id="exportPdf" class="btn btn-ghost" style="margin-top:20px; width:100%; border:1px solid #ddd;">ğŸ“¥
                ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (PDF/Snapshot)</button>
        </div>
    </div>

    <script>
        const BRIDGE_URL = "https://script.google.com/macros/s/AKfycbzCic7XWHobosbwc4PR7_zoS1aZqO6u2UO2-C5Sjm1Nrk7S_iKiCekYa-2Mz84tz-RC/exec";

        document.getElementById('analyzeBtn').onclick = async () => {
            const edu = document.getElementById('education').value;
            const exp = document.getElementById('experience').value;
            const country = document.getElementById('targetCountry').value;
            const field = document.getElementById('targetField').value;

            if (!edu || !exp) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø®Ø¨Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");

            const btn = document.getElementById('analyzeBtn');
            const status = document.getElementById('statusLog');
            btn.disabled = true;
            status.innerText = "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø¹Ù…Ù‚...";

            const prompt = `
            Ø£Ù†Øª Ù…Ø³ØªØ´Ø§Ø± ØªÙˆØ¸ÙŠÙ ÙˆØ®Ø¨ÙŠØ± Ù…Ø³Ø§Ø±Ø§Øª Ù…Ù‡Ù†ÙŠØ© Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¥Ù†Ø³Ø§Ù†ÙŠ ÙˆØ§Ù„Ù…Ù†Ø¸Ù…Ø§Øª ØºÙŠØ± Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ©.
            Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª:
            - Ø§Ù„Ù…Ø¤Ù‡Ù„: ${edu}
            - Ø§Ù„Ø®Ø¨Ø±Ø©: ${exp}
            - Ø§Ù„Ø³ÙŠØ§Ù‚: ${country}
            - Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ù…Ø±ØºÙˆØ¨: ${field}

            Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (JSON Ø­ØµØ±Ø§Ù‹):
            {
                "readiness": "High|Medium|Low",
                "readiness_ar": "Ø¹Ø§Ù„ÙŠØ©|Ù…ØªÙˆØ³Ø·Ø©|Ù…Ù†Ø®ÙØ¶Ø©",
                "summary": "ØªØ­Ù„ÙŠÙ„ Ù…ÙˆØ¬Ø² Ù„Ù„ØªÙˆØ§ÙÙ‚",
                "strengths": ["Ù†Ù‚Ø·Ø© 1", "Ù†Ù‚Ø·Ø© 2"],
                "gaps": ["ÙØ¬ÙˆØ© 1", "ÙØ¬ÙˆØ© 2"],
                "roles": ["ÙˆØ¸ÙŠÙØ© 1", "ÙˆØ¸ÙŠÙØ© 2"],
                "plan": ["Ø®Ø·ÙˆØ© 1", "Ø®Ø·ÙˆØ© 2"],
                "tips": ["Ù†ØµÙŠØ­Ø© 1", "Ù†ØµÙŠØ­Ø© 2"],
                "errors": ["Ø®Ø·Ø£ 1", "Ø®Ø·Ø£ 2"]
            }
            Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª ØªÙƒÙˆÙ† Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.
            `;

            const tryParse = (str) => {
                try { return JSON.parse(str); } catch (e) { return null; }
            };

            const cleanText = (text) => {
                let clean = text.replace(/```json\s*|```\s*/gi, "").trim();
                const start = clean.indexOf('{');
                const end = clean.lastIndexOf('}');
                if (start !== -1 && end !== -1 && end > start) {
                    return clean.substring(start, end + 1);
                }
                return clean;
            };

            try {
                const res = await fetch(BRIDGE_URL + "?action=ai", {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [{ role: "user", content: prompt + "\n\nIMPORTANT: Return ONLY valid JSON." }],
                        temperature: 0.3
                    })
                });

                const dataText = await res.text();
                if (!dataText) throw new Error("Empty response");

                let parsed = tryParse(dataText);
                let content = "";

                if (parsed && parsed.choices && parsed.choices[0] && parsed.choices[0].message) {
                    content = parsed.choices[0].message.content;
                } else {
                    content = dataText;
                }

                // (Fixed) Removed false positive error check
                if (content.startsWith("Error:") || content.includes("Rate limit exceeded")) {
                    status.innerText = "âš ï¸ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø®Ø§Ø¯Ù… Ù…Ø´ØºÙˆÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹.";
                    return;
                }

                const json = tryParse(cleanText(content));
                if (!json) throw new Error("JSON Parsing failed");

                const resultArea = document.getElementById('resultArea');
                const analysisContent = document.getElementById('analysisContent');
                const badge = document.getElementById('readinessBadge');

                badge.innerHTML = `<span class="badge badge-${(json.readiness || 'mid').toLowerCase()}">Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„ØªÙˆØ¸ÙŠÙ: ${json.readiness_ar || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>`;

                analysisContent.innerHTML = `
                    <p><strong>Ø§Ù„Ø®Ù„Ø§ØµØ©:</strong> ${json.summary || ''}</p>
                    
                    <div class="section-title">âœ… Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© Ù„Ø¯ÙŠÙƒ</div>
                    <ul>${(json.strengths || []).map(s => `<li>${s}</li>`).join('')}</ul>

                    <div class="section-title">ğŸ” Ø§Ù„ÙØ¬ÙˆØ§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø±Ø¯Ù…Ù‡Ø§</div>
                    <ul>${(json.gaps || []).map(g => `<li>${g}</li>`).join('')}</ul>

                    <div class="section-title">ğŸ“‚ ÙˆØ¸Ø§Ø¦Ù Ø¨Ø¯Ø§ÙŠØ© Ù…Ù‚ØªØ±Ø­Ø© Ù„Ùƒ</div>
                    <ul>${(json.roles || []).map(r => `<li>${r}</li>`).join('')}</ul>

                    <div class="section-title">ğŸ“… Ø®Ø·Ø© Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ù‚Ø·Ø§Ø¹ (3-6 Ø£Ø´Ù‡Ø±)</div>
                    <ol>${(json.plan || []).map(p => `<li>${p}</li>`).join('')}</ol>

                    <div class="section-title">ğŸ’¡ Ù†ØµØ§Ø¦Ø­ Ø°Ù‡Ø¨ÙŠØ©</div>
                    <ul>${(json.tips || []).map(t => `<li>${t}</li>`).join('')}</ul>

                    <div class="section-title">âš ï¸ Ø£Ø®Ø·Ø§Ø¡ Ø´Ø§Ø¦Ø¹Ø© ØªØ¬Ù†Ø¨Ù‡Ø§</div>
                    <ul style="color:#d32f2f;">${(json.errors || []).map(e => `<li>${e}</li>`).join('')}</ul>
                `;

                resultArea.style.display = 'block';
                status.innerText = "âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!";
                window.scrollTo({ top: resultArea.offsetTop - 50, behavior: 'smooth' });

            } catch (e) {
                console.error("AI Error:", e);
                status.innerText = "âŒ ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.";
            } finally {
                btn.disabled = false;
            }
        };

        document.getElementById('exportPdf').onclick = () => {
            ProtectionManager.verify(() => window.print());
        };
    </script>
</body>

</html>